// 全局状态管理
const AppState = {
    queues: [], // 多个队列 [{ id, name, cards: [{id, front, back, originalDeck}] }]
    currentQueueId: null, // 当前选中的队列
    decks: [],
    currentDeck: null,
    currentQuery: null,
    settings: null,
    allCards: [],
    currentSession: null, // 当前正在学习的会话
    studyingQueueId: null // 正在学习的队列 ID
};

// 初始化
function init() {
    loadSettings();
    loadQueuesFromStorage(); // 从 localStorage 加载队列
    showView('viewCardList');
    showSidebarTab('sidebarDecks');
    bindEvents();
    loadDecks();
}

// 绑定所有事件
function bindEvents() {
    // Tab切换
    document.getElementById('tabDecks').addEventListener('click', () => {
        showSidebarTab('sidebarDecks');
        document.getElementById('tabDecks').classList.add('active');
        document.getElementById('tabQueue').classList.remove('active');
    });

    document.getElementById('tabQueue').addEventListener('click', () => {
        showSidebarTab('sidebarQueue');
        document.getElementById('tabQueue').classList.add('active');
        document.getElementById('tabDecks').classList.remove('active');
        renderQueue();
    });

    // 搜索
    document.getElementById('searchButton').addEventListener('click', performSearch);
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') performSearch();
    });

    // 设置
    document.getElementById('settingsButton').addEventListener('click', () => {
        showView('viewSettings');
    });

    document.getElementById("addModelBtn").addEventListener("click", addEmptyModelRow);
    document.getElementById("addRoleBtn").addEventListener("click", addEmptyRoleRow);
    document.getElementById("saveSettingsBtn").addEventListener("click", saveSettings);

    // 卡片列表操作
    document.getElementById('btnAddSelectedToQueue').addEventListener('click', addSelectedToQueue);
    document.getElementById('btnAddAllDueToQueue').addEventListener('click', addAllDueToQueue);

    // 学习界面
    document.getElementById('btnGetFeedback').addEventListener('click', getFeedback);

    // 评分按钮
    document.querySelectorAll('.rating-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const ease = parseInt(e.target.dataset.ease);
            await rateCard(ease);
        });
    });

    // 添加快捷键：点击队列中的卡片也能开始学习
    document.getElementById('queueList').addEventListener('click', (e) => {
    if (e.target.tagName === 'SPAN') {
        startStudy();
    }
});
}

// 显示/隐藏视图
function showView(viewId) {
    ['viewCardList', 'viewStudy', 'viewSettings'].forEach(id => {
        document.getElementById(id).style.display = 'none';
    });
    document.getElementById(viewId).style.display = 'block';
}

function showSidebarTab(tabId) {
    ['sidebarDecks', 'sidebarQueue'].forEach(id => {
        document.getElementById(id).style.display = 'none';
    });
    document.getElementById(tabId).style.display = 'block';
}

// 加载卡组
async function loadDecks() {
    if (AppState.decks.length > 0) {
        renderDeckTree(AppState.decks);
        // console.log("Decks loaded from cache");
        return;
    }

    const decks = await fetch('/api/decks').then(r => r.json());
    AppState.decks = decks;
    //console.log("Decks loaded from server:", decks);
    renderDeckTree(decks);
}

function renderDeckTree(deckNames) {
    const tree = document.getElementById('deckTree');
    tree.innerHTML = '';

    const deckTree = buildDeckTree(deckNames);
    renderTreeNode(deckTree, tree);
}
// 把 decks 转成一棵树
function buildDeckTree(deckNames) {
    const root = {};

    deckNames.forEach(full => {
        const parts = full.split("::");
        let node = root;

        parts.forEach((p, i) => {
            if (!node[p]) node[p] = { __children: {}, __fullName: parts.slice(0, i + 1).join("::") };
            node = node[p].__children;
        });
    });

    return root;
}
// 递归渲染树节点
function renderTreeNode(tree, container) {
    Object.keys(tree).forEach(name => {
        const info = tree[name];
        const li = document.createElement("li");
        const span = document.createElement("span");
        span.textContent = name;
        li.appendChild(span);
        li.dataset.deckName = info.__fullName;

        li.addEventListener("click", e => {
            e.stopPropagation();
            loadDeckCards(info.__fullName);
        });

        const children = info.__children;
        if (Object.keys(children).length > 0) {
            const toggle = document.createElement("span");
            toggle.className = "toggle-arrow";
            toggle.textContent = "►"; // 初始为折叠状态
            li.insertBefore(toggle, span); // 放在节点名前面

            const ul = document.createElement("ul");
            renderTreeNode(children, ul);
            li.appendChild(ul);
            ul.style.display = "none";
            toggle.addEventListener("click", (e) => {
                e.stopPropagation();
                const isCollapsed = ul.style.display === "none";
                ul.style.display = isCollapsed ? "block" : "none";
                toggle.textContent = isCollapsed ? "▼" : "►";
            });

        }

        container.appendChild(li);
    });
}


// 加载卡组卡片
async function loadDeckCards(deckName) {
    AppState.currentDeck = deckName;
    AppState.currentQuery = `deck:"${deckName}"`;

    const query_result = await apiFindCards(AppState.currentQuery);
    if (!query_result.success) {
        alert("Error loading deck cards: " + query_result.error);
        return;
    }
    const cardIds = query_result.result;
    await loadCardInfo(cardIds);

}

// 根据 cardIds 获取卡片字段
async function loadCardInfo(cardIds) {
    try {
        const response = await fetch(`/api/cards/info`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cardIds })
        });

        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || "Unknown error");
        }
        //这里会增加更多信息
        const cards = data.cards.map(card => ({
            id: card.cardId,
            front: card.front,
            back: card.back,
            queue: card.queue,
            due: card.due,
            nextReviews: card.nextReviews,
            interval: card.interval

        }));

        AppState.allCards = cards;
        renderCardList(cards);
    } catch (error) {
        console.error("Failed to load card info:", error);
    }
}


function renderCardList(cards) {
    const tbody = document.querySelector('#cardTable tbody');
    tbody.innerHTML = '';

    cards.forEach(card => {
        const tr = document.createElement('tr');
        tr.dataset.cardId = card.id;

        // queue 状态映射
        let queueText = '';
        let queueClass = '';

        if (card.queue === 0) {
            queueText = '未学习';
            queueClass = 'queue-new';
        } else if (card.queue === 1) {
            queueText = '学习中';
            queueClass = 'queue-learning';
        } else if (card.queue === 2) {
            //这里逻辑不对，due信息似乎不是表示还有几天到期
            queueText = `待复习 (due: ${card.due})`;
            queueClass = 'queue-due';
        }

        tr.innerHTML = `
          <td><input type="checkbox" class="card-select"></td>
          <td>${stripHtml(card.front).substring(0, 100)}</td>
          <td>
            <span class="queue-tag ${queueClass}">
              ${queueText}
            </span>
          </td>
        `;

        tbody.appendChild(tr);
    });

    showView('viewCardList');
}


function stripHtml(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
}

// 搜索功能
async function performSearch() {
    const query = getSearchQuery();
    if (!query) {
        alert("Please enter a search query");
        return;
    }

    updateSearchState(query);
    const query_result = await apiFindCards(query);
    if (!query_result.success) {
        alert("Search error: " + query_result.error);
        return;
    }
    const cardIds = query_result.result;
    await loadCardInfo(cardIds);
}
//虽然暂时没什么用，但为将来扩展做准备
function getSearchQuery() {
    return document.getElementById('searchInput').value.trim();
}
function updateSearchState(query) {
    AppState.currentQuery = query;
    AppState.currentDeck = null; // 切换到搜索模式
}

//通用搜索接口
async function apiFindCards(query) {
    const response = await fetch('/api/cards/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
    });
    const data = await response.json();
    return data;
}

// 队列管理
function addSelectedToQueue() {
    const checkboxes = document.querySelectorAll('.card-select:checked');
    if (checkboxes.length === 0) {
        alert('Please select at least one card');
        return;
    }

    checkboxes.forEach(cb => {
        const tr = cb.closest('tr');
        const cardId = parseInt(tr.dataset.cardId);
        const cardText = tr.querySelector('td:nth-child(2)').textContent;
        const cardDetail = AppState.allCards.find(c => c.id === cardId);

        if (!AppState.studyQueue.find(c => c.id === cardId) && cardDetail) {
            AppState.studyQueue.push({ id: cardId, front: cardDetail.front, back: cardDetail.back });
        }
    });

    alert(`Added ${checkboxes.length} card(s) to study queue`);
    renderQueue();
}

async function addAllDueToQueue() {
    //这里的逻辑是有问题的，现在的实现仅是把所有卡放进去
    if (AppState.allCards.length === 0) {
        alert('No cards loaded');
        return;
    }
    console.log("Adding all cards to queue:", AppState.allCards);
    AppState.allCards.forEach(card => {
        if (!AppState.studyQueue.find(c => c.id === card.id)) {
            AppState.studyQueue.push({ ...card });
        }
    });

    alert(`Added ${AppState.allCards.length} card(s) to study queue`);
    renderQueue();
}

function renderQueue() {
    const queueList = document.getElementById('queueList');
    queueList.innerHTML = '';

    AppState.studyQueue.forEach((card, index) => {
        const div = document.createElement('div');
        div.className = 'queue-item';
        div.innerHTML = `
          <span>${stripHtml(card.front).substring(0, 50)}</span>
          <button data-index="${index}">Remove</button>
        `;
        div.querySelector('button').addEventListener('click', async () => {
            await removeFromQueue(index);
        });
        queueList.appendChild(div);
    });

    document.getElementById('queueSummary').textContent = `Total: ${AppState.studyQueue.length} cards`;

    // 如果队列有内容，可以开始学习
    if (AppState.studyQueue.length > 0 && AppState.currentCardIndex >= AppState.studyQueue.length) {
        AppState.currentCardIndex = 0;

    }
}

// 从队列中移除卡片
async function removeFromQueue(index) {
    const card = AppState.studyQueue[index];

    // 如果有活跃会话，需要将卡片移回原牌组
    if (AppState.currentSession) {
        try {
            const response = await fetch('/api/session/remove-card', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sessionId: AppState.currentSession.sessionId,
                    cardId: card.id
                })
            });

            const data = await response.json();

            if (!data.success) {
                alert('Failed to remove card: ' + data.error);
                return;
            }

            // 如果会话中没有卡片了，清理会话
            if (data.remainingCards === 0) {
                AppState.currentSession = null;
                await loadSessions();
            }

        } catch (err) {
            console.error('Failed to remove card from session:', err);
            alert('Failed to remove card');
            return;
        }
    }

    // 从前端队列移除
    AppState.studyQueue.splice(index, 1);
    renderQueue();
}

// 学习功能
async function startStudy() {
    if (AppState.studyQueue.length === 0) {
        alert('Study queue is empty. Please add cards first.');
        return;
    }

    // 创建学习会话
    const cardIds = AppState.studyQueue.map(c => c.id);

    try {
        const response = await fetch('/api/session/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cardIds })
        });

        const data = await response.json();

        if (!data.success) {
            alert('Failed to start study session: ' + data.error);
            return;
        }

        AppState.currentSession = {
            sessionId: data.sessionId,
            tempDeckName: data.tempDeckName,
            cardCount: data.cardCount
        };

        console.log('Study session started:', AppState.currentSession);

        // 刷新会话列表
        await loadSessions();

        // 在 Anki 中打开临时牌组
        await openAnkiReview(data.tempDeckName);

        // 开始学习流程
        AppState.currentCardIndex = 0;
        await loadCurrentCard();
        showView('viewStudy');

    } catch (err) {
        console.error('Failed to start study:', err);
        alert('Failed to start study session');
    }
}

// 在 Anki 中打开复习界面
async function openAnkiReview(deckName) {
    try {
        const response = await fetch('/api/anki/review-deck', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ deckName })
        });

        const data = await response.json();

        if (!data.success) {
            console.warn('Failed to open Anki review:', data.error);
        }
    } catch (err) {
        console.warn('Failed to open Anki review:', err);
    }
}

async function loadCurrentCard() {
    if (AppState.currentCardIndex >= AppState.studyQueue.length) {
        alert('No more cards in queue!');
        return;
    }

    const card = AppState.studyQueue[AppState.currentCardIndex];
    document.getElementById('studyFront').textContent = stripHtml(card.front);
    document.getElementById('studyQuestion').textContent = 'Generating question...';
    document.getElementById('studyAnswer').value = '';
    document.getElementById('studyFeedback').textContent = '';

    // 生成AI问题
    await generateQuestion(card);
}
// 调用后端AI接口生成问题
async function generateQuestion(card) {
    const cardText = stripHtml(card.front);

    try {
        const response = await fetch('/api/ai/generate-question', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                roleName: 'teacherQuestion',
                cardFront: cardText,
                cardBack: card.back
            })
        });

        const data = await response.json();

        if (!data.success) {
            console.error('AI error:', data.error);
            document.getElementById('studyQuestion').textContent =
                'Error generating question.';
            return;
        }

        document.getElementById('studyQuestion').textContent = data.question;
        card.question = data.question;
    } catch (e) {
        console.error('generateQuestion failed:', e);
        document.getElementById('studyQuestion').textContent =
            'Error generating question.';
    }
}

// 调用后端AI接口获取反馈
async function getFeedback() {
    const answer = document.getElementById('studyAnswer').value.trim();
    if (!answer) {
        alert('Write your answer first.');
        return;
    }

    const card = AppState.studyQueue[AppState.currentCardIndex];
    const cardFront = card.front;
    const cardBack = card.back;
    const question = card.question || document.getElementById('studyQuestion').textContent;

    document.getElementById('studyFeedback').textContent = 'Getting feedback...';

    try {
        const response = await fetch('/api/ai/feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                roleName: 'teacherFeedback',
                cardFront,
                cardBack,
                question,
                answer
            })
        });

        const data = await response.json();

        if (!data.success) {
            console.error('AI error:', data.error);
            document.getElementById('studyFeedback').textContent =
                'Error getting feedback.';
            return;
        }

        document.getElementById('studyFeedback').textContent = data.feedback;

    } catch (e) {
        console.error('getFeedback failed:', e);
        document.getElementById('studyFeedback').textContent =
            'Error getting feedback.';
    }
}


// 评分卡片并更新 Anki
async function rateCard(ease) {
    try {
        const response = await fetch('/api/anki/answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ease })
        });

        const data = await response.json();

        if (!data.success) {
            alert('Failed to rate card: ' + data.error);
            return;
        }

        // 评分成功，进入下一张卡片
        nextCard();

    } catch (err) {
        console.error('Failed to rate card:', err);
        alert('Failed to rate card');
    }
}


function nextCard() {
    AppState.currentCardIndex++;
    if (AppState.currentCardIndex >= AppState.studyQueue.length) {
        // 学习完成，结束会话
        endStudySession();
        return;
    }
    loadCurrentCard();
}

// 结束学习会话
async function endStudySession() {
    if (!AppState.currentSession) {
        alert('You have completed all cards in the queue!');
        showView('viewCardList');
        return;
    }

    try {
        const response = await fetch('/api/session/end', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId: AppState.currentSession.sessionId })
        });

        const data = await response.json();

        if (!data.success) {
            console.error('Failed to end session:', data.error);
        }

        AppState.currentSession = null;
        AppState.studyQueue = [];
        renderQueue();

        // 刷新会话列表
        await loadSessions();

        alert('Study session completed! Cards have been moved back to their original decks.');
        showView('viewCardList');

    } catch (err) {
        console.error('Failed to end session:', err);
        alert('Study session completed, but cleanup may have failed.');
        showView('viewCardList');
    }
}

// 加载所有会话列表
async function loadSessions() {
    try {
        const response = await fetch('/api/session/list');
        const data = await response.json();

        if (data.success) {
            AppState.allSessions = data.sessions;
            console.log('Active sessions:', AppState.allSessions);
        }
    } catch (err) {
        console.error('Failed to load sessions:', err);
    }
}







// 启动应用
init();


